# インフラ構築手順書

## =====注意=====

構築するインフラはCloudFormationで立ち上げる形にしたため、
以下のドキュメントは実際には使用していない。

CloudFormationでの立ち上げ方法は
/cloudformation/README.md を参照

## 前提

* VPC作成済み
  - aws-and-infra-vpc
* サブネット作成済み
  - aws-and-infla-public-subnet-1a
  - aws-and-infla-public-subnet-1c
  - aws-and-infla-private-subnet-1a
  - aws-and-infla-private-subnet-1c

## 手順

### 1. セキュリティグループの作成

```bash
# ALB用セキュリティグループ
aws ec2 create-security-group \
  --group-name yuria-alb-sg \
  --description "Security group for ALB" \
  --vpc-id <VPC_ID> \
  --region ap-northeast-1

# HTTP(80)とHTTPS(443)を許可
aws ec2 authorize-security-group-ingress \
  --group-id <ALB_SG_ID> \
  --protocol tcp \
  --port 80 \
  --cidr 0.0.0.0/0 \
  --region ap-northeast-1

aws ec2 authorize-security-group-ingress \
  --group-id <ALB_SG_ID> \
  --protocol tcp \
  --port 443 \
  --cidr 0.0.0.0/0 \
  --region ap-northeast-1

# ECSタスク用セキュリティグループ作成
aws ec2 create-security-group \
  --group-name yuria-ecs-sg \
  --description "Security group for ECS tasks" \
  --vpc-id <VPC_ID> \
  --region ap-northeast-1

# ALBからのアクセスを許可（ポート3000と5000）
aws ec2 authorize-security-group-ingress \
  --group-id <ECS_SG_ID> \
  --protocol tcp \
  --port 3000 \
  --source-group <ALB_SG_ID> \
  --region ap-northeast-1

aws ec2 authorize-security-group-ingress \
  --group-id <ECS_SG_ID> \
  --protocol tcp \
  --port 5000 \
  --source-group <ALB_SG_ID> \
  --region ap-northeast-1
```

### 2. IAMロールの作成

```bash
# ECSタスク実行ロールの作成（ECRからイメージをプルする権限）
cat > ecs-task-execution-role-trust-policy.json << 'EOF'
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "ecs-tasks.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
EOF

aws iam create-role \
  --role-name ecsTaskExecutionRole \
  --assume-role-policy-document file://ecs-task-execution-role-trust-policy.json

# 必要なポリシーをアタッチ
aws iam attach-role-policy \
  --role-name ecsTaskExecutionRole \
  --policy-arn arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
```

### 3. ECSクラスターの作成

```bash
aws ecs create-cluster \
  --cluster-name yuria-cluster \
  --region ap-northeast-1
```

### 4. ALBの作成

```bash
# ALB作成（サブネットIDは2つ以上指定）
aws elbv2 create-load-balancer \
  --name yuria-alb \
  --subnets <SUBNET_ID_1> <SUBNET_ID_2> \
  --security-groups <ALB_SG_ID> \
  --scheme internet-facing \
  --type application \
  --ip-address-type ipv4 \
  --region ap-northeast-1
```

### 5. ターゲットグループの作成

```bash
# webapp用ターゲットグループ
aws elbv2 create-target-group \
  --name webapp-target-group \
  --protocol HTTP \
  --port 3000 \
  --vpc-id <VPC_ID> \
  --target-type ip \
  --health-check-enabled \
  --health-check-protocol HTTP \
  --health-check-path / \
  --health-check-interval-seconds 30 \
  --health-check-timeout-seconds 5 \
  --healthy-threshold-count 2 \
  --unhealthy-threshold-count 3 \
  --matcher HttpCode=200 \
  --region ap-northeast-1

# botapp用ターゲットグループ
aws elbv2 create-target-group \
  --name botapp-target-group \
  --protocol HTTP \
  --port 5000 \
  --vpc-id <VPC_ID> \
  --target-type ip \
  --health-check-enabled \
  --health-check-protocol HTTP \
  --health-check-path /api/healthCheck \
  --health-check-interval-seconds 30 \
  --health-check-timeout-seconds 5 \
  --healthy-threshold-count 2 \
  --unhealthy-threshold-count 3 \
  --matcher HttpCode=200 \
  --region ap-northeast-1
```

### 6. ALBリスナーとルーティングルールの作成

```bash
# デフォルトリスナー作成（webappへ）
aws elbv2 create-listener \
  --load-balancer-arn <ALB_ARN> \
  --protocol HTTP \
  --port 80 \
  --default-actions Type=forward,TargetGroupArn=<WEBAPP_TG_ARN> \
  --region ap-northeast-1

# リスナーARNをメモ

# /api/* へのルーティングルール追加（botappへ）
aws elbv2 create-rule \
  --listener-arn <LISTENER_ARN> \
  --priority 1 \
  --conditions Field=path-pattern,Values='/api/*' \
  --actions Type=forward,TargetGroupArn=<BOTAPP_TG_ARN> \
  --region ap-northeast-1
```

### 7. タスク定義の作成

```bash
# webapp用タスク定義
cat > webapp-task-definition.json << 'EOF'
{
  "family": "webapp-task",
  "networkMode": "awsvpc",
  "requiresCompatibilities": ["FARGATE"],
  "cpu": "256",
  "memory": "512",
  "executionRoleArn": "arn:aws:iam::<ACCOUNT_ID>:role/ecsTaskExecutionRole",
  "containerDefinitions": [
    {
      "name": "webapp",
      "image": "<ACCOUNT_ID>.dkr.ecr.ap-northeast-1.amazonaws.com/yuria/webapp:latest",
      "portMappings": [
        {
          "containerPort": 3000,
          "protocol": "tcp"
        }
      ],
      "essential": true,
      "logConfiguration": {
        "logDriver": "awslogs",
        "options": {
          "awslogs-group": "/ecs/webapp",
          "awslogs-region": "ap-northeast-1",
          "awslogs-stream-prefix": "ecs"
        }
      }
    }
  ]
}
EOF

# CloudWatch Logsグループ作成
aws logs create-log-group --log-group-name /ecs/webapp --region ap-northeast-1

# タスク定義を登録
aws ecs register-task-definition \
  --cli-input-json file://webapp-task-definition.json \
  --region ap-northeast-1

# botapp用タスク定義
cat > botapp-task-definition.json << 'EOF'
{
  "family": "botapp-task",
  "networkMode": "awsvpc",
  "requiresCompatibilities": ["FARGATE"],
  "cpu": "256",
  "memory": "512",
  "executionRoleArn": "arn:aws:iam::<ACCOUNT_ID>:role/ecsTaskExecutionRole",
  "containerDefinitions": [
    {
      "name": "botapp",
      "image": "<ACCOUNT_ID>.dkr.ecr.ap-northeast-1.amazonaws.com/yuria/botapp:latest",
      "portMappings": [
        {
          "containerPort": 5000,
          "protocol": "tcp"
        }
      ],
      "essential": true,
      "logConfiguration": {
        "logDriver": "awslogs",
        "options": {
          "awslogs-group": "/ecs/botapp",
          "awslogs-region": "ap-northeast-1",
          "awslogs-stream-prefix": "ecs"
        }
      }
    }
  ]
}
EOF

aws logs create-log-group --log-group-name /ecs/botapp --region ap-northeast-1

aws ecs register-task-definition \
  --cli-input-json file://botapp-task-definition.json \
  --region ap-northeast-1
```

### 8. ECSサービスの作成

```bash
# webapp-service作成
aws ecs create-service \
  --cluster yuria-cluster \
  --service-name webapp-service \
  --task-definition webapp-task \
  --desired-count 1 \
  --launch-type FARGATE \
  --network-configuration "awsvpcConfiguration={subnets=[<SUBNET_ID_1>,<SUBNET_ID_2>],securityGroups=[<ECS_SG_ID>],assignPublicIp=ENABLED}" \
  --load-balancers "targetGroupArn=<WEBAPP_TG_ARN>,containerName=webapp,containerPort=3000" \
  --region ap-northeast-1

# botapp-service作成
aws ecs create-service \
  --cluster yuria-cluster \
  --service-name botapp-service \
  --task-definition botapp-task \
  --desired-count 1 \
  --launch-type FARGATE \
  --network-configuration "awsvpcConfiguration={subnets=[<SUBNET_ID_1>,<SUBNET_ID_2>],securityGroups=[<ECS_SG_ID>],assignPublicIp=ENABLED}" \
  --load-balancers "targetGroupArn=<BOTAPP_TG_ARN>,containerName=botapp,containerPort=5000" \
  --region ap-northeast-1
```

### 9. 確認

```bash
# サービス状態確認
aws ecs describe-services \
  --cluster yuria-cluster \
  --services webapp-service botapp-service \
  --region ap-northeast-1

# ALBのDNS名取得
aws elbv2 describe-load-balancers \
  --names yuria-alb \
  --query 'LoadBalancers[0].DNSName' \
  --output text \
  --region ap-northeast-1

# ブラウザでアクセス
# http://<ALB_DNS_NAME>/        → webapp
# http://<ALB_DNS_NAME>/api/*   → botapp
```